<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Klaviyo Integration Test</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    button {
      background: #3182ce;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover { background: #2c5282; }
    button.secondary {
      background: #718096;
    }
    button.success {
      background: #38a169;
    }
    .log {
      background: #1a1a2e;
      color: #00ff00;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .log .error { color: #ff6b6b; }
    .log .warn { color: #ffd93d; }
    .log .success { color: #6bcb77; }
    .log .info { color: #4d96ff; }
    .status {
      padding: 10px 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-weight: 500;
    }
    .status.pending { background: #fef3c7; color: #92400e; }
    .status.success { background: #d1fae5; color: #065f46; }
    .status.error { background: #fee2e2; color: #991b1b; }
    .checklist {
      list-style: none;
      padding: 0;
    }
    .checklist li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .checklist li:before {
      content: '‚¨ú';
      margin-right: 10px;
    }
    .checklist li.checked:before {
      content: '‚úÖ';
    }
    .checklist li.failed:before {
      content: '‚ùå';
    }
    .note {
      background: #ebf8ff;
      border-left: 4px solid #3182ce;
      padding: 12px;
      margin: 15px 0;
      font-size: 13px;
    }
    .note.warning {
      background: #fffbeb;
      border-color: #f59e0b;
    }
  </style>
</head>
<body>
  <h1>üß™ Klaviyo Integration Test</h1>
  
  <div class="card">
    <h2>1. Configuration</h2>
    <div class="form-group">
      <label>Company ID (Public API Key / Site ID)</label>
      <input type="text" id="companyId" value="X987Jt" placeholder="e.g., X987Jt">
    </div>
    <div class="form-group">
      <label>List ID</label>
      <input type="text" id="listId" value="SWfNg6" placeholder="e.g., SWfNg6">
    </div>
    <div class="form-group">
      <label>API Revision</label>
      <input type="text" id="revision" value="2024-10-15" placeholder="e.g., 2024-10-15">
    </div>
    <div class="note">
      <strong>Where to find these:</strong><br>
      ‚Ä¢ Company ID: Klaviyo ‚Üí Settings ‚Üí Account ‚Üí API Keys ‚Üí Site ID (public key)<br>
      ‚Ä¢ List ID: Klaviyo ‚Üí Lists ‚Üí Click on list ‚Üí The ID is in the URL after /list/
    </div>
  </div>

  <div class="card">
    <h2>2. Test Profile Data</h2>
    <div class="form-group">
      <label>Email *</label>
      <input type="email" id="testEmail" placeholder="test@example.com">
    </div>
    <div class="form-group">
      <label>First Name</label>
      <input type="text" id="testFirstName" value="Test" placeholder="First name">
    </div>
    <div class="form-group">
      <label>Last Name</label>
      <input type="text" id="testLastName" value="User" placeholder="Last name">
    </div>
    <div class="form-group">
      <label>Phone Number (optional, E.164 format)</label>
      <input type="tel" id="testPhone" placeholder="+15551234567">
    </div>
    <div class="note warning">
      <strong>‚ö†Ô∏è Use a real email you can check!</strong> If your list has double opt-in enabled, you'll need to confirm the subscription via email to see the profile appear in the list.
    </div>
  </div>

  <div class="card">
    <h2>3. Run Tests</h2>
    <button onclick="testSubscription()">üöÄ Test Subscription API</button>
    <button class="secondary" onclick="testProfileCreate()">üë§ Test Profile Create API</button>
    <button class="secondary" onclick="clearLog()">üóëÔ∏è Clear Log</button>
    
    <div id="status" class="status pending" style="margin-top: 15px;">Ready to test</div>
  </div>

  <div class="card">
    <h2>4. Verification Checklist</h2>
    <ul class="checklist" id="checklist">
      <li id="check-request">API request sent successfully</li>
      <li id="check-status">Response status is 202 (Accepted)</li>
      <li id="check-no-errors">No errors in response</li>
      <li id="check-cors">No CORS errors</li>
      <li id="check-phone">Phone number processed (if provided)</li>
    </ul>
    <div class="note">
      <strong>After testing:</strong><br>
      1. Check your Klaviyo account ‚Üí Profiles ‚Üí Search for the test email<br>
      2. Check the specific List ‚Üí Members<br>
      3. If double opt-in: Check inbox for confirmation email<br>
      4. Profile may take 30-60 seconds to appear due to async processing
    </div>
  </div>

  <div class="card">
    <h2>5. Debug Log</h2>
    <div class="log" id="log">Waiting for test...</div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function clearLog() {
      logEl.innerHTML = '';
      document.querySelectorAll('.checklist li').forEach(li => {
        li.classList.remove('checked', 'failed');
      });
      statusEl.className = 'status pending';
      statusEl.textContent = 'Ready to test';
    }

    function setCheck(id, success) {
      const el = document.getElementById(id);
      el.classList.remove('checked', 'failed');
      el.classList.add(success ? 'checked' : 'failed');
    }

    async function testSubscription() {
      clearLog();
      log('Starting subscription test...', 'info');
      
      const companyId = document.getElementById('companyId').value.trim();
      const listId = document.getElementById('listId').value.trim();
      const revision = document.getElementById('revision').value.trim();
      const email = document.getElementById('testEmail').value.trim();
      const firstName = document.getElementById('testFirstName').value.trim();
      const lastName = document.getElementById('testLastName').value.trim();
      const phone = document.getElementById('testPhone').value.trim();

      if (!companyId || !listId || !email) {
        log('ERROR: Company ID, List ID, and Email are required!', 'error');
        statusEl.className = 'status error';
        statusEl.textContent = 'Missing required fields';
        return;
      }

      statusEl.className = 'status pending';
      statusEl.textContent = 'Testing...';

      // Build profile attributes
      const profileAttributes = {
        email: email,
        first_name: firstName,
        last_name: lastName,
        properties: {
          'Test Property': 'Test Value',
          'Source': 'Klaviyo Test Page'
        }
      };

      // Add phone if provided
      if (phone) {
        profileAttributes.phone_number = phone;
        log(`Phone number included: ${phone}`, 'info');
      }

      // Build subscriptions object
      const subscriptions = {
        email: {
          marketing: {
            consent: 'SUBSCRIBED'
          }
        }
      };

      if (phone) {
        subscriptions.sms = {
          marketing: {
            consent: 'SUBSCRIBED'
          }
        };
      }

      profileAttributes.subscriptions = subscriptions;

      // Build full payload
      const payload = {
        data: {
          type: 'subscription',
          attributes: {
            custom_source: 'Klaviyo Test Page',
            profile: {
              data: {
                type: 'profile',
                attributes: profileAttributes
              }
            }
          },
          relationships: {
            list: {
              data: {
                type: 'list',
                id: listId
              }
            }
          }
        }
      };

      log('Payload:', 'info');
      log(JSON.stringify(payload, null, 2), 'info');

      const url = `https://a.klaviyo.com/client/subscriptions/?company_id=${companyId}`;
      log(`URL: ${url}`, 'info');

      try {
        log('Sending request...', 'info');
        setCheck('check-request', true);

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/vnd.api+json',
            'revision': revision
          },
          body: JSON.stringify(payload)
        });

        log(`Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
        setCheck('check-status', response.status === 202);
        setCheck('check-cors', true);

        // Log headers
        const headers = {};
        response.headers.forEach((value, key) => { headers[key] = value; });
        log('Response headers: ' + JSON.stringify(headers, null, 2), 'info');

        // Check for partial failure
        const partialFailure = response.headers.get('X-Klaviyo-Partial-Failure');
        if (partialFailure) {
          log(`Partial failure detected: ${partialFailure}`, 'warn');
          setCheck('check-phone', false);
        } else if (phone) {
          setCheck('check-phone', true);
        }

        if (response.ok || response.status === 202) {
          log('‚úÖ SUCCESS! Subscription request accepted.', 'success');
          log('Note: 202 means the request is being processed asynchronously.', 'info');
          log('The profile may take 30-60 seconds to appear in Klaviyo.', 'info');
          setCheck('check-no-errors', true);
          statusEl.className = 'status success';
          statusEl.textContent = '‚úÖ Success! Check Klaviyo in 30-60 seconds.';
        } else {
          const responseText = await response.text();
          log('Response body:', 'error');
          log(responseText, 'error');
          
          try {
            const errorData = JSON.parse(responseText);
            if (errorData.errors) {
              errorData.errors.forEach((err, i) => {
                log(`Error ${i+1}: ${err.title} - ${err.detail} (at ${err.source?.pointer})`, 'error');
              });
            }
          } catch (e) {}
          
          setCheck('check-no-errors', false);
          statusEl.className = 'status error';
          statusEl.textContent = `‚ùå Error: ${response.status}`;
        }

      } catch (error) {
        log(`Network error: ${error.message}`, 'error');
        setCheck('check-request', false);
        setCheck('check-cors', false);
        
        if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
          log('This might be a CORS error. Make sure you are using the correct public API key.', 'warn');
        }
        
        statusEl.className = 'status error';
        statusEl.textContent = '‚ùå Network error (see log)';
      }
    }

    async function testProfileCreate() {
      clearLog();
      log('Starting profile creation test (without subscription)...', 'info');
      
      const companyId = document.getElementById('companyId').value.trim();
      const revision = document.getElementById('revision').value.trim();
      const email = document.getElementById('testEmail').value.trim();
      const firstName = document.getElementById('testFirstName').value.trim();
      const lastName = document.getElementById('testLastName').value.trim();
      const phone = document.getElementById('testPhone').value.trim();

      if (!companyId || !email) {
        log('ERROR: Company ID and Email are required!', 'error');
        statusEl.className = 'status error';
        statusEl.textContent = 'Missing required fields';
        return;
      }

      statusEl.className = 'status pending';
      statusEl.textContent = 'Testing...';

      const profileAttributes = {
        email: email,
        first_name: firstName,
        last_name: lastName,
        properties: {
          'Test Property': 'Profile Create Test',
          'Source': 'Klaviyo Test Page'
        }
      };

      if (phone) {
        profileAttributes.phone_number = phone;
      }

      const payload = {
        data: {
          type: 'profile',
          attributes: profileAttributes
        }
      };

      log('Payload:', 'info');
      log(JSON.stringify(payload, null, 2), 'info');

      const url = `https://a.klaviyo.com/client/profiles/?company_id=${companyId}`;
      log(`URL: ${url}`, 'info');

      try {
        log('Sending request...', 'info');
        setCheck('check-request', true);

        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/vnd.api+json',
            'revision': revision
          },
          body: JSON.stringify(payload)
        });

        log(`Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
        setCheck('check-status', response.status === 202);
        setCheck('check-cors', true);

        if (response.ok || response.status === 202) {
          log('‚úÖ SUCCESS! Profile creation request accepted.', 'success');
          log('Note: This creates/updates the profile but does NOT subscribe them to the list.', 'info');
          setCheck('check-no-errors', true);
          statusEl.className = 'status success';
          statusEl.textContent = '‚úÖ Profile created/updated!';
        } else {
          const responseText = await response.text();
          log('Response body:', 'error');
          log(responseText, 'error');
          setCheck('check-no-errors', false);
          statusEl.className = 'status error';
          statusEl.textContent = `‚ùå Error: ${response.status}`;
        }

      } catch (error) {
        log(`Network error: ${error.message}`, 'error');
        setCheck('check-request', false);
        setCheck('check-cors', false);
        statusEl.className = 'status error';
        statusEl.textContent = '‚ùå Network error (see log)';
      }
    }
  </script>
</body>
</html>
