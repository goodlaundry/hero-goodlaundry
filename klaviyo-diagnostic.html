<!DOCTYPE html>
<html>
<head>
  <title>Klaviyo API Diagnostic</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
    .test { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
    .test h3 { margin-top: 0; }
    .success { background: #d4edda; border-color: #28a745; }
    .error { background: #f8d7da; border-color: #dc3545; }
    .pending { background: #fff3cd; border-color: #ffc107; }
    pre { background: #f5f5f5; padding: 10px; overflow-x: auto; font-size: 12px; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 5px; }
    input { padding: 8px; margin: 5px 0; width: 300px; }
  </style>
</head>
<body>
  <h1>Klaviyo API Diagnostic Test</h1>
  
  <div class="test">
    <h3>Configuration</h3>
    <p><label>Company ID (Public Key): <input type="text" id="companyId" value="X987Jt"></label></p>
    <p><label>List ID: <input type="text" id="listId" value="SWfNg6"></label></p>
    <p><label>Test Email: <input type="email" id="testEmail" value=""></label></p>
    <p><small>Use a REAL email you control - Klaviyo may filter fake-looking emails</small></p>
  </div>

  <div class="test" id="test1">
    <h3>Test 1: Basic API Connectivity</h3>
    <p>Tests if we can reach Klaviyo's API at all</p>
    <button onclick="runTest1()">Run Test</button>
    <div id="result1"></div>
  </div>

  <div class="test" id="test2">
    <h3>Test 2: Create Profile Only (no subscription)</h3>
    <p>Tests if we can create a profile using the client profiles endpoint</p>
    <button onclick="runTest2()">Run Test</button>
    <div id="result2"></div>
  </div>

  <div class="test" id="test3">
    <h3>Test 3: Subscribe with Minimal Payload</h3>
    <p>Tests subscription with the simplest possible payload (email only)</p>
    <button onclick="runTest3()">Run Test</button>
    <div id="result3"></div>
  </div>

  <div class="test" id="test4">
    <h3>Test 4: Subscribe WITHOUT a List</h3>
    <p>Tests if account-level settings are blocking (uses account default)</p>
    <button onclick="runTest4()">Run Test</button>
    <div id="result4"></div>
  </div>

  <script>
    const API_REVISION = '2024-10-15';

    function getConfig() {
      return {
        companyId: document.getElementById('companyId').value.trim(),
        listId: document.getElementById('listId').value.trim(),
        email: document.getElementById('testEmail').value.trim().toLowerCase()
      };
    }

    function showResult(testNum, success, message, details = '') {
      const el = document.getElementById('result' + testNum);
      const testEl = document.getElementById('test' + testNum);
      testEl.className = 'test ' + (success ? 'success' : 'error');
      el.innerHTML = `<p><strong>${success ? '✅' : '❌'} ${message}</strong></p>${details ? `<pre>${details}</pre>` : ''}`;
    }

    // Test 1: Basic connectivity
    async function runTest1() {
      const { companyId } = getConfig();
      document.getElementById('result1').innerHTML = '<p>Testing...</p>';
      
      try {
        // Just try to hit the API with an invalid request to see if it responds
        const response = await fetch(`https://a.klaviyo.com/client/profiles/?company_id=${companyId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/vnd.api+json',
            'revision': API_REVISION
          },
          body: JSON.stringify({})
        });
        
        const text = await response.text();
        
        if (response.status === 400) {
          showResult(1, true, 'API is reachable and responding', `Status: ${response.status}\nThis is expected - we sent an empty request.\n\nResponse: ${text}`);
        } else {
          showResult(1, false, `Unexpected status: ${response.status}`, text);
        }
      } catch (error) {
        showResult(1, false, 'Network error - cannot reach Klaviyo', error.message);
      }
    }

    // Test 2: Create profile only
    async function runTest2() {
      const { companyId, email } = getConfig();
      
      if (!email) {
        showResult(2, false, 'Please enter your email address above');
        return;
      }
      
      document.getElementById('result2').innerHTML = '<p>Testing...</p>';
      
      const payload = {
        data: {
          type: 'profile',
          attributes: {
            email: email,
            first_name: 'API',
            last_name: 'Test',
            properties: {
              'Test Source': 'Diagnostic Page',
              'Test Time': new Date().toISOString()
            }
          }
        }
      };
      
      try {
        const response = await fetch(`https://a.klaviyo.com/client/profiles/?company_id=${companyId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/vnd.api+json',
            'revision': API_REVISION
          },
          body: JSON.stringify(payload)
        });
        
        const text = await response.text();
        
        if (response.status === 201 || response.status === 202) {
          showResult(2, true, 'Profile created/updated successfully!', `Status: ${response.status}\n\nCheck Klaviyo for profile: ${email}\n\nResponse: ${text || '(empty)'}`);
        } else {
          showResult(2, false, `Failed with status ${response.status}`, `Payload sent:\n${JSON.stringify(payload, null, 2)}\n\nResponse:\n${text}`);
        }
      } catch (error) {
        showResult(2, false, 'Network error', error.message);
      }
    }

    // Test 3: Minimal subscription
    async function runTest3() {
      const { companyId, listId, email } = getConfig();
      
      if (!email) {
        showResult(3, false, 'Please enter your email address above');
        return;
      }
      
      document.getElementById('result3').innerHTML = '<p>Testing...</p>';
      
      // Absolute minimal payload
      const payload = {
        data: {
          type: 'subscription',
          attributes: {
            profile: {
              data: {
                type: 'profile',
                attributes: {
                  email: email
                }
              }
            }
          },
          relationships: {
            list: {
              data: {
                type: 'list',
                id: listId
              }
            }
          }
        }
      };
      
      try {
        const response = await fetch(`https://a.klaviyo.com/client/subscriptions/?company_id=${companyId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/vnd.api+json',
            'revision': API_REVISION
          },
          body: JSON.stringify(payload)
        });
        
        const text = await response.text();
        
        if (response.status === 202) {
          showResult(3, true, 'Request accepted (202)', `Check Klaviyo for: ${email}\n\nPayload sent:\n${JSON.stringify(payload, null, 2)}\n\nResponse: ${text || '(empty - this is normal)'}`);
        } else {
          showResult(3, false, `Failed with status ${response.status}`, `Payload sent:\n${JSON.stringify(payload, null, 2)}\n\nResponse:\n${text}`);
        }
      } catch (error) {
        showResult(3, false, 'Network error', error.message);
      }
    }

    // Test 4: Subscribe without list (uses account default)
    async function runTest4() {
      const { companyId, email } = getConfig();
      
      if (!email) {
        showResult(4, false, 'Please enter your email address above');
        return;
      }
      
      document.getElementById('result4').innerHTML = '<p>Testing...</p>';
      
      // No list relationship - uses account default opt-in
      const payload = {
        data: {
          type: 'subscription',
          attributes: {
            profile: {
              data: {
                type: 'profile',
                attributes: {
                  email: email,
                  subscriptions: {
                    email: {
                      marketing: {
                        consent: 'SUBSCRIBED'
                      }
                    }
                  }
                }
              }
            }
          }
        }
      };
      
      try {
        const response = await fetch(`https://a.klaviyo.com/client/subscriptions/?company_id=${companyId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/vnd.api+json',
            'revision': API_REVISION
          },
          body: JSON.stringify(payload)
        });
        
        const text = await response.text();
        
        if (response.status === 202) {
          showResult(4, true, 'Request accepted (202)', `This used your ACCOUNT-LEVEL default opt-in settings.\nCheck Klaviyo for: ${email}\n\nIf this works but Test 3 doesn't, the issue is with your LIST settings.\n\nResponse: ${text || '(empty)'}`);
        } else {
          showResult(4, false, `Failed with status ${response.status}`, `Payload sent:\n${JSON.stringify(payload, null, 2)}\n\nResponse:\n${text}`);
        }
      } catch (error) {
        showResult(4, false, 'Network error', error.message);
      }
    }
  </script>
</body>
</html>
